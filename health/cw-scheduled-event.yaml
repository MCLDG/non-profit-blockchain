# Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License").
# You may not use this file except in compliance with the License.
# A copy of the License is located at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# or in the "license" file accompanying this file. This file is distributed
# on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
# express or implied. See the License for the specific language governing
# permissions and limitations under the License.
 
AWSTemplateFormatVersion: 2010-09-09
Description: Amazon Managed Blockchain. Creates a CW scheduled event that triggers the peer health check Lambda
Metadata:
  LICENSE: Apache License Version 2.0
Parameters:
  NetworkId:
    Description: The network ID of the Amazon Managed Blockchain network you want to execute the health check against
    Type: String
  MemberId:
    Description: The member ID you want to execute the health check against
    Type: String
  LambdaFunctionARN:
    Description: The peer health check Lambda function that is invoked by the CW scheduled event. The ARN is required, not only the name
    Type: String

Resources:
  ScheduledRule: 
    Type: AWS::Events::Rule
    Properties: 
      Description: ScheduledRule
      ScheduleExpression: "rate(1 minute)"
      State: ENABLED
      Targets: 
        - 
          Arn: 
            !Ref: LambdaFunctionARN
          Id: PeerHealthCheckv1
          Input: !Sub |
            {
              "networkId": "${NetworkId}",
              "memberId": "${MemberId}"
            }
  PermissionForEventsToInvokeLambda: 
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: !Ref: LambdaFunctionARN
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: 
        Fn::GetAtt: 
          - ScheduledRule
          - Arn
          
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Protocol: email
        Endpoint: !Ref NotificationEmail

  Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Ref AlarmTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref LambdaFunctionARN
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: '1'
      
Outputs:
  ScheduledRule:
    Description: CW Scheduled Rule
    Value: !Ref ScheduledRule
    Export:
      Name: !Sub "${AWS::StackName}-ScheduledRule"
